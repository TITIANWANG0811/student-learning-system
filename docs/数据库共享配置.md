# 数据库和Redis共享配置

## 概述

为了优化资源使用，初中生学习管理系统可以与现有项目共享PostgreSQL和Redis服务，通过数据库和命名空间进行隔离。

## PostgreSQL数据库共享

### 1. 数据库隔离策略

#### 方案一：独立数据库（推荐）
```sql
-- 为学习管理系统创建独立数据库
CREATE DATABASE student_learning_system;
CREATE USER student_learning_user WITH PASSWORD 'secure_password';
GRANT ALL PRIVILEGES ON DATABASE student_learning_system TO student_learning_user;
```

#### 方案二：表名前缀隔离
```sql
-- 如果使用同一数据库，所有表名添加前缀
-- 例如：sls_users, sls_subjects, sls_study_plans 等
```

### 2. 连接配置

#### 独立数据库配置
```python
# backend/config.py
DATABASE_URL = "postgresql://student_learning_user:secure_password@localhost:5432/student_learning_system"
```

#### 共享数据库配置（如果选择方案二）
```python
# backend/config.py
DATABASE_URL = "postgresql://shared_user:shared_password@localhost:5432/shared_database"

# 在模型定义中添加表前缀
class User(Base):
    __tablename__ = "sls_users"  # 添加 sls_ 前缀
    # ... 其他字段
```

### 3. 数据库初始化

```bash
# 创建数据库和用户
sudo -u postgres psql
CREATE DATABASE student_learning_system;
CREATE USER student_learning_user WITH PASSWORD 'secure_password';
GRANT ALL PRIVILEGES ON DATABASE student_learning_system TO student_learning_user;
\q

# 导入数据库结构
psql -h localhost -U student_learning_user -d student_learning_system -f database/schema.sql
```

## Redis共享配置

### 1. Redis数据库隔离

Redis支持16个数据库（0-15），可以通过数据库编号进行隔离：

```python
# backend/config.py
# 学习管理系统使用数据库1
REDIS_URL = "redis://localhost:6379/1"

# 其他项目可以使用不同的数据库编号
# 项目A: redis://localhost:6379/0
# 项目B: redis://localhost:6379/2
# 学习管理系统: redis://localhost:6379/1
```

### 2. 键名命名空间

为了进一步避免键名冲突，可以在Redis键名前添加命名空间：

```python
# backend/core/redis_client.py
import redis
from config import settings

class RedisClient:
    def __init__(self):
        self.redis = redis.from_url(settings.redis_url, decode_responses=True)
        self.namespace = "sls:"  # 学习管理系统命名空间
    
    def get(self, key):
        return self.redis.get(f"{self.namespace}{key}")
    
    def set(self, key, value, ex=None):
        return self.redis.set(f"{self.namespace}{key}", value, ex=ex)
    
    def delete(self, key):
        return self.redis.delete(f"{self.namespace}{key}")
    
    def exists(self, key):
        return self.redis.exists(f"{self.namespace}{key}")

# 使用示例
redis_client = RedisClient()
redis_client.set("user:123", "user_data")  # 实际存储为 "sls:user:123"
```

### 3. Redis配置优化

```bash
# 编辑Redis配置
sudo nano /etc/redis/redis.conf

# 确保以下配置
maxmemory 2gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

## 环境变量配置

### 1. 开发环境

创建 `backend/.env` 文件：

```env
# 数据库配置
DATABASE_URL=postgresql://student_learning_user:secure_password@localhost:5432/student_learning_system
REDIS_URL=redis://localhost:6379/1

# 其他配置...
```

### 2. 生产环境

```env
# 生产环境配置
DATABASE_URL=postgresql://student_learning_user:production_password@db-server:5432/student_learning_system
REDIS_URL=redis://redis-server:6379/1
```

## 监控和维护

### 1. 数据库监控

```sql
-- 查看数据库大小
SELECT pg_size_pretty(pg_database_size('student_learning_system'));

-- 查看表大小
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 查看连接数
SELECT count(*) FROM pg_stat_activity WHERE datname = 'student_learning_system';
```

### 2. Redis监控

```bash
# 查看Redis信息
redis-cli info

# 查看数据库1的使用情况
redis-cli -n 1 info keyspace

# 查看键名模式
redis-cli -n 1 keys "sls:*"

# 查看内存使用
redis-cli info memory
```

### 3. 备份策略

#### PostgreSQL备份
```bash
# 创建备份脚本
#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份学习管理系统数据库
pg_dump -h localhost -U student_learning_user student_learning_system > $BACKUP_DIR/student_learning_system_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/student_learning_system_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "student_learning_system_*.sql.gz" -mtime +7 -delete
```

#### Redis备份
```bash
# Redis持久化配置已启用，定期检查RDB文件
ls -la /var/lib/redis/dump.rdb

# 手动创建快照
redis-cli bgsave
```

## 安全考虑

### 1. 数据库安全

```sql
-- 创建只读用户（用于报表等）
CREATE USER student_learning_readonly WITH PASSWORD 'readonly_password';
GRANT CONNECT ON DATABASE student_learning_system TO student_learning_readonly;
GRANT USAGE ON SCHEMA public TO student_learning_readonly;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO student_learning_readonly;
```

### 2. Redis安全

```bash
# 设置Redis密码
redis-cli config set requirepass "your_redis_password"

# 更新连接配置
REDIS_URL=redis://:your_redis_password@localhost:6379/1
```

### 3. 网络安全

```bash
# 限制数据库访问
# 在postgresql.conf中设置
listen_addresses = 'localhost'

# 在pg_hba.conf中配置
local   student_learning_system   student_learning_user   md5
host    student_learning_system   student_learning_user   127.0.0.1/32   md5
```

## 性能优化

### 1. 数据库优化

```sql
-- 创建索引
CREATE INDEX CONCURRENTLY idx_sls_users_username ON sls_users(username);
CREATE INDEX CONCURRENTLY idx_sls_study_tasks_student_date ON sls_study_tasks(student_id, scheduled_date);

-- 分析表统计信息
ANALYZE;
```

### 2. Redis优化

```python
# 使用连接池
import redis.connection

pool = redis.ConnectionPool.from_url(settings.redis_url, max_connections=20)
redis_client = redis.Redis(connection_pool=pool)
```

## 故障排除

### 1. 连接问题

```bash
# 检查PostgreSQL连接
psql -h localhost -U student_learning_user -d student_learning_system -c "SELECT version();"

# 检查Redis连接
redis-cli -n 1 ping
```

### 2. 权限问题

```sql
-- 检查用户权限
\du student_learning_user

-- 重新授权
GRANT ALL PRIVILEGES ON DATABASE student_learning_system TO student_learning_user;
```

### 3. 性能问题

```bash
# 检查慢查询
tail -f /var/log/postgresql/postgresql-*.log | grep "slow"

# 检查Redis内存使用
redis-cli info memory | grep used_memory_human
```

## 迁移指南

### 1. 从独立安装迁移到共享

```bash
# 1. 停止现有服务
sudo systemctl stop postgresql
sudo systemctl stop redis

# 2. 备份数据
pg_dump student_learning_system > backup.sql
redis-cli --rdb backup.rdb

# 3. 配置共享服务
# 按照上述配置步骤进行

# 4. 恢复数据
psql -h localhost -U student_learning_user -d student_learning_system < backup.sql
redis-cli -n 1 < backup.rdb
```

### 2. 从共享迁移到独立

```bash
# 1. 导出数据
pg_dump -h localhost -U student_learning_user student_learning_system > export.sql

# 2. 安装独立服务
# 按照标准安装流程

# 3. 导入数据
psql -h new-server -U new_user -d new_database < export.sql
```

## 总结

通过数据库和命名空间隔离，可以安全地与其他项目共享PostgreSQL和Redis服务，实现：

- **资源优化**：避免重复安装和配置
- **数据隔离**：确保各项目数据安全
- **维护简化**：统一管理数据库服务
- **成本降低**：减少服务器资源占用

建议使用独立数据库 + Redis数据库隔离的方案，既保证了数据安全，又实现了资源共享。
