# 部署指南

## 生产环境部署

### 1. 服务器要求

**最低配置**:
- CPU: 2核心
- 内存: 4GB
- 存储: 20GB SSD
- 操作系统: Ubuntu 20.04 LTS 或 CentOS 8

**推荐配置**:
- CPU: 4核心
- 内存: 8GB
- 存储: 50GB SSD
- 操作系统: Ubuntu 22.04 LTS

### 2. 环境准备

#### 安装系统依赖

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y python3.9 python3.9-venv python3-pip nodejs npm postgresql redis-server nginx

# CentOS/RHEL
sudo yum update
sudo yum install -y python39 python39-pip nodejs npm postgresql-server redis nginx
```

#### 安装Docker（可选）

```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 3. 数据库配置

#### PostgreSQL配置

```bash
# 启动PostgreSQL服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库和用户
sudo -u postgres psql
CREATE DATABASE student_learning_system;
CREATE USER app_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE student_learning_system TO app_user;
\q
```

#### Redis配置

```bash
# 启动Redis服务
sudo systemctl start redis
sudo systemctl enable redis

# 配置Redis（可选）
sudo nano /etc/redis/redis.conf
# 设置密码和内存限制
```

### 4. 应用部署

#### 克隆代码

```bash
cd /opt
sudo git clone <repository-url> student-learning-system
sudo chown -R $USER:$USER student-learning-system
cd student-learning-system
```

#### 后端部署

```bash
cd backend

# 创建虚拟环境
python3.9 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
nano .env
```

**生产环境配置**:
```env
# 数据库配置
DATABASE_URL=postgresql://app_user:your_secure_password@localhost:5432/student_learning_system
REDIS_URL=redis://localhost:6379/0

# JWT配置
SECRET_KEY=your_very_secure_secret_key_here
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=60

# 应用配置
APP_NAME=初中生学习管理系统
APP_VERSION=1.0.0
DEBUG=False
HOST=0.0.0.0
PORT=8000

# 文件上传配置
UPLOAD_DIR=/opt/student-learning-system/uploads
MAX_FILE_SIZE=10485760

# CORS配置
ALLOWED_ORIGINS=["https://yourdomain.com", "https://www.yourdomain.com"]
```

```bash
# 创建上传目录
mkdir -p uploads
chmod 755 uploads

# 初始化数据库
python -c "from app.core.database import engine, Base; Base.metadata.create_all(bind=engine)"

# 测试运行
python main.py
```

#### 前端部署

```bash
cd frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 安装serve（用于静态文件服务）
npm install -g serve

# 测试构建结果
serve -s build -l 3000
```

### 5. 进程管理

#### 使用systemd管理后端服务

创建服务文件：

```bash
sudo nano /etc/systemd/system/student-learning-backend.service
```

```ini
[Unit]
Description=Student Learning System Backend
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/student-learning-system/backend
Environment=PATH=/opt/student-learning-system/backend/venv/bin
ExecStart=/opt/student-learning-system/backend/venv/bin/python main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable student-learning-backend
sudo systemctl start student-learning-backend
sudo systemctl status student-learning-backend
```

#### 使用PM2管理前端服务

```bash
# 安装PM2
npm install -g pm2

# 创建PM2配置文件
nano ecosystem.config.js
```

```javascript
module.exports = {
  apps: [{
    name: 'student-learning-frontend',
    script: 'serve',
    args: '-s build -l 3000',
    cwd: '/opt/student-learning-system/frontend',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
}
```

```bash
# 启动前端服务
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

### 6. Nginx配置

#### 安装和配置Nginx

```bash
# 安装Nginx
sudo apt install nginx  # Ubuntu
sudo yum install nginx  # CentOS

# 创建配置文件
sudo nano /etc/nginx/sites-available/student-learning-system
```

```nginx
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    # 前端静态文件
    location / {
        proxy_pass http://localhost:9003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后端API
    location /api/ {
        proxy_pass http://localhost:9002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/student-learning-system /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 7. SSL证书配置

#### 使用Let's Encrypt

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx  # Ubuntu
sudo yum install certbot python3-certbot-nginx  # CentOS

# 获取SSL证书
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 设置自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

### 8. 监控和日志

#### 设置日志轮转

```bash
# 后端日志
sudo nano /etc/logrotate.d/student-learning-backend
```

```
/opt/student-learning-system/backend/logs/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload student-learning-backend
    endscript
}
```

#### 监控脚本

```bash
# 创建监控脚本
nano /opt/student-learning-system/monitor.sh
```

```bash
#!/bin/bash

# 检查后端服务
if ! systemctl is-active --quiet student-learning-backend; then
    echo "$(date): Backend service is down, restarting..." >> /var/log/student-learning-monitor.log
    systemctl restart student-learning-backend
fi

# 检查前端服务
if ! pm2 list | grep -q "student-learning-frontend.*online"; then
    echo "$(date): Frontend service is down, restarting..." >> /var/log/student-learning-monitor.log
    pm2 restart student-learning-frontend
fi

# 检查数据库连接
if ! pg_isready -h localhost -p 5432 -U app_user; then
    echo "$(date): Database connection failed" >> /var/log/student-learning-monitor.log
fi
```

```bash
chmod +x /opt/student-learning-system/monitor.sh

# 添加到crontab
crontab -e
# 添加以下行（每5分钟检查一次）
*/5 * * * * /opt/student-learning-system/monitor.sh
```

### 9. 备份策略

#### 数据库备份

```bash
# 创建备份脚本
nano /opt/student-learning-system/backup.sh
```

```bash
#!/bin/bash

BACKUP_DIR="/opt/backups/student-learning-system"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -h localhost -U app_user student_learning_system > $BACKUP_DIR/db_backup_$DATE.sql

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /opt/student-learning-system/uploads

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "$(date): Backup completed" >> /var/log/student-learning-backup.log
```

```bash
chmod +x /opt/student-learning-system/backup.sh

# 添加到crontab（每天凌晨2点备份）
0 2 * * * /opt/student-learning-system/backup.sh
```

### 10. Docker部署（可选）

#### 创建Docker Compose文件

```yaml
# docker-compose.yml
version: '3.8'

services:
  db:
    image: postgres:13
    environment:
      POSTGRES_DB: student_learning_system
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: your_secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"

  backend:
    build: ./backend
    environment:
      DATABASE_URL: postgresql://app_user:your_secure_password@db:5432/student_learning_system
      REDIS_URL: redis://redis:6379/0
    ports:
      - "9002:9002"
    depends_on:
      - db
      - redis
    volumes:
      - ./uploads:/app/uploads

  frontend:
    build: ./frontend
    ports:
      - "9003:9003"
    depends_on:
      - backend

volumes:
  postgres_data:
```

#### 构建和运行

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 11. 性能优化

#### 数据库优化

```sql
-- 创建索引
CREATE INDEX CONCURRENTLY idx_study_tasks_student_date ON study_tasks(student_id, scheduled_date);
CREATE INDEX CONCURRENTLY idx_notes_student_subject ON notes(student_id, subject_id);
CREATE INDEX CONCURRENTLY idx_learning_progress_student ON learning_progress(student_id);

-- 分析表统计信息
ANALYZE;
```

#### 应用优化

```python
# 在config.py中添加
# 数据库连接池配置
SQLALCHEMY_ENGINE_OPTIONS = {
    "pool_size": 20,
    "max_overflow": 30,
    "pool_pre_ping": True,
    "pool_recycle": 300
}

# Redis连接池配置
REDIS_POOL_SIZE = 20
```

### 12. 安全加固

#### 防火墙配置

```bash
# 配置UFW防火墙
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw deny 9002  # 禁止直接访问后端端口
sudo ufw deny 9003  # 禁止直接访问前端端口
```

#### 系统安全

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 配置自动安全更新
sudo apt install unattended-upgrades
sudo dpkg-reconfigure unattended-upgrades

# 禁用不必要的服务
sudo systemctl disable bluetooth
sudo systemctl disable cups
```

### 13. 故障排除

#### 常见问题

1. **服务无法启动**
   ```bash
   # 检查日志
   sudo journalctl -u student-learning-backend -f
   pm2 logs student-learning-frontend
   ```

2. **数据库连接失败**
   ```bash
   # 检查PostgreSQL状态
   sudo systemctl status postgresql
   sudo -u postgres psql -c "SELECT version();"
   ```

3. **内存不足**
   ```bash
   # 检查内存使用
   free -h
   # 添加swap空间
   sudo fallocate -l 2G /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   sudo swapon /swapfile
   ```

4. **磁盘空间不足**
   ```bash
   # 清理日志文件
   sudo journalctl --vacuum-time=7d
   # 清理Docker（如果使用）
   docker system prune -a
   ```

### 14. 维护检查清单

**每日检查**:
- [ ] 服务状态正常
- [ ] 磁盘空间充足
- [ ] 内存使用正常
- [ ] 错误日志无异常

**每周检查**:
- [ ] 数据库备份正常
- [ ] 系统更新
- [ ] 性能监控
- [ ] 安全扫描

**每月检查**:
- [ ] 完整系统备份
- [ ] 安全更新
- [ ] 性能优化
- [ ] 容量规划

---

通过以上步骤，您就可以成功部署一个生产环境的初中生学习管理系统。记得根据实际需求调整配置参数，并定期进行系统维护。
