# 初中生学习管理系统 - 设计文档

## 1. 系统架构设计

### 1.1 总体架构

系统采用前后端分离的微服务架构，基于以下技术栈：

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用      │    │   后端API       │    │   数据存储      │
│   React + TS    │◄──►│   FastAPI       │◄──►│   PostgreSQL    │
│   Ant Design    │    │   SQLAlchemy    │    │   Redis         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 技术架构

#### 1.2.1 前端技术栈
- **框架**：React 18 + TypeScript
- **UI组件库**：Ant Design
- **状态管理**：React Context + Hooks
- **路由管理**：React Router v6
- **HTTP客户端**：Axios
- **图表库**：Chart.js
- **构建工具**：Create React App

#### 1.2.2 后端技术栈
- **框架**：FastAPI
- **ORM**：SQLAlchemy
- **数据库**：PostgreSQL
- **缓存**：Redis
- **认证**：JWT
- **密码加密**：bcrypt
- **数据验证**：Pydantic

#### 1.2.3 数据库设计
- **主数据库**：PostgreSQL
- **缓存数据库**：Redis
- **文件存储**：本地文件系统
- **备份策略**：定期数据库备份

### 1.3 系统分层架构

```
┌─────────────────────────────────────────────────────────┐
│                    表现层 (Presentation Layer)          │
│  React Components + Ant Design + React Router          │
├─────────────────────────────────────────────────────────┤
│                    业务逻辑层 (Business Logic Layer)     │
│  FastAPI Routes + Services + Business Logic            │
├─────────────────────────────────────────────────────────┤
│                    数据访问层 (Data Access Layer)        │
│  SQLAlchemy ORM + Redis Client + File System           │
├─────────────────────────────────────────────────────────┤
│                    数据存储层 (Data Storage Layer)       │
│  PostgreSQL + Redis + File System                      │
└─────────────────────────────────────────────────────────┘
```

## 2. 数据库设计

### 2.1 数据库架构

#### 2.1.1 数据库选择
- **主数据库**：PostgreSQL 13+
- **缓存数据库**：Redis 6+
- **连接池**：SQLAlchemy连接池
- **事务管理**：ACID事务支持

#### 2.1.2 数据库命名规范
- **表名**：使用下划线分隔的小写字母
- **字段名**：使用下划线分隔的小写字母
- **索引名**：idx_表名_字段名
- **外键名**：fk_表名_字段名

### 2.2 核心数据表设计

#### 2.2.1 用户表 (users)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'student',
    grade VARCHAR(10),
    class_name VARCHAR(50),
    avatar_url VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.2 学科表 (subjects)
```sql
CREATE TABLE subjects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) NOT NULL,
    description TEXT,
    grade VARCHAR(10) NOT NULL,
    order_index INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.3 学习计划表 (study_plans)
```sql
CREATE TABLE study_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    subject_id UUID NOT NULL REFERENCES subjects(id),
    title VARCHAR(100) NOT NULL,
    description TEXT,
    plan_type VARCHAR(20) NOT NULL, -- daily, weekly, monthly, semester
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.4 学习任务表 (study_tasks)
```sql
CREATE TABLE study_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    subject_id UUID NOT NULL REFERENCES subjects(id),
    study_plan_id UUID REFERENCES study_plans(id),
    title VARCHAR(100) NOT NULL,
    description TEXT,
    task_type VARCHAR(20) NOT NULL, -- reading, practice, memorization, dictation, review
    priority VARCHAR(10) DEFAULT 'medium',
    due_date TIMESTAMP WITH TIME ZONE,
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.5 笔记表 (notes)
```sql
CREATE TABLE notes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    subject_id UUID NOT NULL REFERENCES subjects(id),
    title VARCHAR(100) NOT NULL,
    content TEXT NOT NULL,
    note_type VARCHAR(20) NOT NULL, -- class, reading, error, review
    tags TEXT[],
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.6 作业表 (assignments)
```sql
CREATE TABLE assignments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    subject_id UUID NOT NULL REFERENCES subjects(id),
    title VARCHAR(100) NOT NULL,
    description TEXT,
    assignment_type VARCHAR(20) NOT NULL, -- daily, holiday, special, optional
    due_date TIMESTAMP WITH TIME ZONE NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    score INTEGER,
    feedback TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.7 考试表 (exams)
```sql
CREATE TABLE exams (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    subject_id UUID NOT NULL REFERENCES subjects(id),
    title VARCHAR(100) NOT NULL,
    exam_type VARCHAR(20) NOT NULL, -- quiz, test, midterm, final
    exam_date TIMESTAMP WITH TIME ZONE NOT NULL,
    duration INTEGER, -- 考试时长（分钟）
    total_score INTEGER NOT NULL,
    score INTEGER,
    status VARCHAR(20) DEFAULT 'scheduled',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.8 学习进度表 (study_progress)
```sql
CREATE TABLE study_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    subject_id UUID NOT NULL REFERENCES subjects(id),
    study_date DATE NOT NULL,
    study_time INTEGER DEFAULT 0, -- 学习时长（分钟）
    tasks_completed INTEGER DEFAULT 0,
    tasks_total INTEGER DEFAULT 0,
    accuracy_rate DECIMAL(5,2) DEFAULT 0.00,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.9 提醒表 (reminders)
```sql
CREATE TABLE reminders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    title VARCHAR(100) NOT NULL,
    content TEXT,
    reminder_type VARCHAR(20) NOT NULL, -- study, exam, assignment, review
    reminder_time TIMESTAMP WITH TIME ZONE NOT NULL,
    is_sent BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### 2.3 数据库索引设计

#### 2.3.1 主要索引
```sql
-- 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);

-- 学习任务表索引
CREATE INDEX idx_study_tasks_user_id ON study_tasks(user_id);
CREATE INDEX idx_study_tasks_subject_id ON study_tasks(subject_id);
CREATE INDEX idx_study_tasks_due_date ON study_tasks(due_date);
CREATE INDEX idx_study_tasks_status ON study_tasks(status);

-- 学习进度表索引
CREATE INDEX idx_study_progress_user_id ON study_progress(user_id);
CREATE INDEX idx_study_progress_study_date ON study_progress(study_date);

-- 提醒表索引
CREATE INDEX idx_reminders_user_id ON reminders(user_id);
CREATE INDEX idx_reminders_reminder_time ON reminders(reminder_time);
```

## 3. API设计

### 3.1 RESTful API设计原则

#### 3.1.1 URL设计规范
```
GET    /api/v1/users              # 获取用户列表
GET    /api/v1/users/{id}         # 获取特定用户
POST   /api/v1/users              # 创建用户
PUT    /api/v1/users/{id}         # 更新用户
DELETE /api/v1/users/{id}         # 删除用户
```

#### 3.1.2 HTTP状态码使用
- **200 OK**：请求成功
- **201 Created**：资源创建成功
- **400 Bad Request**：请求参数错误
- **401 Unauthorized**：未授权访问
- **403 Forbidden**：禁止访问
- **404 Not Found**：资源不存在
- **500 Internal Server Error**：服务器内部错误

### 3.2 核心API接口

#### 3.2.1 认证接口
```python
# 用户注册
POST /api/v1/auth/register
{
    "username": "string",
    "email": "string",
    "password": "string",
    "role": "student|parent|admin"
}

# 用户登录
POST /api/v1/auth/login
{
    "username": "string",
    "password": "string"
}

# 刷新令牌
POST /api/v1/auth/refresh
{
    "refresh_token": "string"
}
```

#### 3.2.2 用户管理接口
```python
# 获取用户信息
GET /api/v1/users/profile

# 更新用户信息
PUT /api/v1/users/profile
{
    "grade": "string",
    "class_name": "string",
    "avatar_url": "string"
}
```

#### 3.2.3 学科管理接口
```python
# 获取学科列表
GET /api/v1/subjects

# 获取特定学科
GET /api/v1/subjects/{id}
```

#### 3.2.4 学习计划接口
```python
# 创建学习计划
POST /api/v1/study-plans
{
    "subject_id": "uuid",
    "title": "string",
    "description": "string",
    "plan_type": "daily|weekly|monthly|semester",
    "start_date": "date",
    "end_date": "date"
}

# 获取学习计划列表
GET /api/v1/study-plans?subject_id={id}&plan_type={type}
```

#### 3.2.5 学习任务接口
```python
# 创建学习任务
POST /api/v1/study-tasks
{
    "subject_id": "uuid",
    "study_plan_id": "uuid",
    "title": "string",
    "description": "string",
    "task_type": "reading|practice|memorization|dictation|review",
    "priority": "low|medium|high",
    "due_date": "datetime"
}

# 获取学习任务列表
GET /api/v1/study-tasks?status={status}&due_date={date}
```

### 3.3 数据验证设计

#### 3.3.1 Pydantic模型设计
```python
class UserCreate(BaseModel):
    username: str = Field(..., min_length=3, max_length=50)
    email: str = Field(..., regex=r'^[\w\.-]+@[\w\.-]+\.\w+$')
    password: str = Field(..., min_length=6)
    role: str = Field(..., regex=r'^(student|parent|admin)$')

class StudyTaskCreate(BaseModel):
    subject_id: UUID
    study_plan_id: Optional[UUID] = None
    title: str = Field(..., min_length=1, max_length=100)
    description: Optional[str] = None
    task_type: str = Field(..., regex=r'^(reading|practice|memorization|dictation|review)$')
    priority: str = Field(default='medium', regex=r'^(low|medium|high)$')
    due_date: Optional[datetime] = None
```

## 4. 前端设计

### 4.1 组件架构设计

#### 4.1.1 组件层次结构
```
App
├── Layout
│   ├── Header
│   ├── Sidebar
│   └── MainContent
├── Pages
│   ├── Login
│   ├── Register
│   ├── Dashboard
│   ├── StudyPlan
│   ├── StudyTasks
│   ├── Notes
│   ├── Assignments
│   ├── Practice
│   ├── Exams
│   ├── Progress
│   └── Settings
└── Components
    ├── Common
    │   ├── Loading
    │   ├── ErrorBoundary
    │   └── ConfirmDialog
    └── Forms
        ├── LoginForm
        ├── RegisterForm
        └── TaskForm
```

#### 4.1.2 状态管理设计
```typescript
// 认证状态
interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
}

// 学习状态
interface StudyState {
  subjects: Subject[];
  studyPlans: StudyPlan[];
  studyTasks: StudyTask[];
  currentSubject: Subject | null;
}

// 应用状态
interface AppState {
  theme: 'light' | 'dark';
  language: 'zh' | 'en';
  sidebarCollapsed: boolean;
}
```

### 4.2 页面设计

#### 4.2.1 登录页面
- **布局**：居中卡片式布局
- **功能**：用户名/邮箱登录、密码登录、记住密码
- **验证**：实时表单验证、错误提示
- **响应式**：支持移动端适配

#### 4.2.2 仪表板页面
- **布局**：网格布局，显示关键信息
- **组件**：
  - 学习进度概览
  - 今日任务列表
  - 最近学习记录
  - 成绩趋势图表
- **交互**：点击跳转到详细页面

#### 4.2.3 学习计划页面
- **布局**：时间轴布局
- **功能**：
  - 创建学习计划
  - 查看计划详情
  - 编辑计划内容
  - 删除计划
- **视图**：日视图、周视图、月视图

#### 4.2.4 学习任务页面
- **布局**：列表布局，支持筛选和排序
- **功能**：
  - 任务列表展示
  - 任务状态更新
  - 任务优先级调整
  - 任务搜索和筛选
- **状态**：待完成、进行中、已完成、已延期

### 4.3 用户体验设计

#### 4.3.1 交互设计原则
- **简洁性**：界面简洁，操作直观
- **一致性**：保持设计风格一致
- **反馈性**：及时的操作反馈
- **容错性**：友好的错误处理

#### 4.3.2 视觉设计规范
- **色彩方案**：
  - 主色调：#1890ff（蓝色）
  - 辅助色：#52c41a（绿色）、#faad14（橙色）
  - 中性色：#f5f5f5（浅灰）、#262626（深灰）
- **字体规范**：
  - 标题：16px-24px，加粗
  - 正文：14px，常规
  - 辅助文字：12px，浅色
- **间距规范**：8px、16px、24px、32px

## 5. 安全设计

### 5.1 认证与授权

#### 5.1.1 JWT认证机制
```python
# JWT配置
SECRET_KEY = "your-secret-key"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30
REFRESH_TOKEN_EXPIRE_DAYS = 7

# 令牌生成
def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt
```

#### 5.1.2 密码安全
```python
# 密码哈希
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def get_password_hash(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)
```

### 5.2 数据安全

#### 5.2.1 数据加密
- **传输加密**：HTTPS协议
- **存储加密**：敏感数据加密存储
- **密码加密**：bcrypt哈希加密
- **令牌加密**：JWT签名加密

#### 5.2.2 访问控制
```python
# 基于角色的访问控制
class RoleChecker:
    def __init__(self, allowed_roles: List[str]):
        self.allowed_roles = allowed_roles

    def __call__(self, user: User = Depends(get_current_user)):
        if user.role not in self.allowed_roles:
            raise HTTPException(
                status_code=403,
                detail="Operation not permitted"
            )
```

### 5.3 输入验证

#### 5.3.1 SQL注入防护
- 使用SQLAlchemy ORM
- 参数化查询
- 输入验证和过滤

#### 5.3.2 XSS防护
- 输入内容转义
- CSP（内容安全策略）
- 输出内容过滤

## 6. 性能设计

### 6.1 缓存策略

#### 6.1.1 Redis缓存设计
```python
# 缓存键设计
CACHE_KEYS = {
    'user_profile': 'user:profile:{user_id}',
    'study_progress': 'study:progress:{user_id}:{date}',
    'subject_list': 'subjects:list',
    'study_plan': 'study:plan:{user_id}:{plan_id}'
}

# 缓存过期时间
CACHE_EXPIRY = {
    'user_profile': 3600,  # 1小时
    'study_progress': 1800,  # 30分钟
    'subject_list': 7200,  # 2小时
    'study_plan': 1800  # 30分钟
}
```

#### 6.1.2 数据库查询优化
- 合理使用索引
- 避免N+1查询
- 使用连接查询
- 分页查询

### 6.2 前端性能优化

#### 6.2.1 代码分割
```typescript
// 路由懒加载
const Dashboard = lazy(() => import('./pages/Dashboard'));
const StudyPlan = lazy(() => import('./pages/StudyPlan'));
const StudyTasks = lazy(() => import('./pages/StudyTasks'));
```

#### 6.2.2 资源优化
- 图片压缩和懒加载
- CSS和JS文件压缩
- 静态资源CDN
- 浏览器缓存策略

## 7. 部署设计

### 7.1 容器化部署

#### 7.1.1 Docker配置
```dockerfile
# 后端Dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
EXPOSE 9002

CMD ["python", "main.py"]
```

```dockerfile
# 前端Dockerfile
FROM node:16-alpine

WORKDIR /app
COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

EXPOSE 9003
CMD ["npm", "start"]
```

#### 7.1.2 Docker Compose配置
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: student_learning_system
      POSTGRES_USER: student_learning_user
      POSTGRES_PASSWORD: secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"

  backend:
    build: ./backend
    ports:
      - "9002:9002"
    depends_on:
      - postgres
      - redis
    environment:
      - DATABASE_URL=postgresql://student_learning_user:secure_password@postgres:5432/student_learning_system
      - REDIS_URL=redis://redis:6379/1

  frontend:
    build: ./frontend
    ports:
      - "9003:9003"
    depends_on:
      - backend

volumes:
  postgres_data:
```

### 7.2 生产环境配置

#### 7.2.1 环境变量配置
```bash
# 生产环境配置
DATABASE_URL=postgresql://user:password@localhost:5432/student_learning_system
REDIS_URL=redis://localhost:6379/1
SECRET_KEY=your-production-secret-key
DEBUG=False
ALLOWED_ORIGINS=["https://yourdomain.com"]
```

#### 7.2.2 反向代理配置
```nginx
# Nginx配置
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://localhost:9003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/ {
        proxy_pass http://localhost:9002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 8. 监控与日志

### 8.1 日志设计

#### 8.1.1 日志级别
- **DEBUG**：调试信息
- **INFO**：一般信息
- **WARNING**：警告信息
- **ERROR**：错误信息
- **CRITICAL**：严重错误

#### 8.1.2 日志格式
```python
import logging

# 日志配置
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/app.log'),
        logging.StreamHandler()
    ]
)
```

### 8.2 监控指标

#### 8.2.1 系统监控
- CPU使用率
- 内存使用率
- 磁盘使用率
- 网络流量

#### 8.2.2 应用监控
- 请求响应时间
- 错误率
- 并发用户数
- 数据库连接数

## 9. 测试设计

### 9.1 测试策略

#### 9.1.1 测试层次
- **单元测试**：测试单个函数或方法
- **集成测试**：测试模块间交互
- **端到端测试**：测试完整用户流程
- **性能测试**：测试系统性能

#### 9.1.2 测试工具
- **后端测试**：pytest + FastAPI TestClient
- **前端测试**：Jest + React Testing Library
- **API测试**：Postman + Newman
- **性能测试**：JMeter

### 9.2 测试用例设计

#### 9.2.1 功能测试用例
```python
def test_user_registration():
    """测试用户注册功能"""
    response = client.post("/api/v1/auth/register", json={
        "username": "testuser",
        "email": "test@example.com",
        "password": "password123",
        "role": "student"
    })
    assert response.status_code == 201
    assert response.json()["username"] == "testuser"
```

#### 9.2.2 性能测试用例
```python
def test_concurrent_users():
    """测试并发用户访问"""
    # 模拟100个并发用户
    # 验证系统响应时间和稳定性
    pass
```

## 10. 维护与扩展

### 10.1 代码维护

#### 10.1.1 代码规范
- **Python**：PEP 8规范
- **TypeScript**：ESLint + Prettier
- **Git**：Git Flow工作流
- **文档**：Markdown格式

#### 10.1.2 版本控制
- **语义化版本**：MAJOR.MINOR.PATCH
- **分支策略**：main、develop、feature、hotfix
- **标签管理**：每个版本打标签
- **变更日志**：记录版本变更

### 10.2 系统扩展

#### 10.2.1 水平扩展
- **负载均衡**：Nginx负载均衡
- **数据库分片**：按用户ID分片
- **缓存集群**：Redis集群
- **微服务拆分**：按业务模块拆分

#### 10.2.2 功能扩展
- **移动端支持**：React Native
- **AI功能**：智能推荐、自动批改
- **社交功能**：学习小组、讨论区
- **数据分析**：学习行为分析

## 11. 附录

### 11.1 技术选型说明

#### 11.1.1 为什么选择FastAPI？
- 高性能：基于Starlette和Pydantic
- 自动文档：自动生成OpenAPI文档
- 类型提示：完整的类型支持
- 异步支持：原生异步支持

#### 11.1.2 为什么选择React？
- 组件化：可复用的UI组件
- 生态丰富：庞大的第三方库
- 性能优秀：虚拟DOM和优化
- 社区活跃：持续更新和维护

### 11.2 参考资源

#### 11.2.1 技术文档
- [FastAPI官方文档](https://fastapi.tiangolo.com/)
- [React官方文档](https://reactjs.org/)
- [PostgreSQL文档](https://www.postgresql.org/docs/)
- [Redis文档](https://redis.io/documentation)

#### 11.2.2 设计规范
- [Ant Design设计语言](https://ant.design/)
- [Material Design指南](https://material.io/design)
- [Web可访问性指南](https://www.w3.org/WAI/WCAG21/quickref/)
